<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BigChat Video</title>
  <style>
    body {
      background: #111;
      color: #00aaff;
      font-family: Arial, sans-serif;
      text-align: center;
      padding-top: 40px;
    }
    video {
      width: 45%;
      border: 2px solid #00aaff;
      margin: 10px;
      border-radius: 8px;
    }
  </style>
</head>
<body>

  <h1>BigChat Video Call</h1>

  <video id="localVideo" autoplay playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>

  <script>
    const serverUrl = "ws://localhost:3000"; // ndrysho këtë nëse serveri yt është online
    
    const connection = new WebSocket(serverUrl);
    let localStream;
    let peer;

    connection.onopen = () => {
      console.log("Connected to signaling server");
    };

    connection.onmessage = (msg) => {
      let data = JSON.parse(msg.data);
      if (data.type === "offer") handleOffer(data.offer);
      if (data.type === "answer") handleAnswer(data.answer);
      if (data.type === "candidate") {
        peer.addIceCandidate(new RTCIceCandidate(data.candidate));
      }
    };

    async function start() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      document.getElementById("localVideo").srcObject = localStream;

      peer = new RTCPeerConnection();

      peer.ontrack = (e) => {
        document.getElementById("remoteVideo").srcObject = e.streams[0];
      };

      localStream.getTracks().forEach(track => peer.addTrack(track, localStream));

      peer.onicecandidate = e => {
        if (e.candidate) {
          connection.send(JSON.stringify({ type: "candidate", candidate: e.candidate }));
        }
      };

      const offer = await peer.createOffer();
      await peer.setLocalDescription(offer);

      connection.send(JSON.stringify({ type: "offer", offer }));
    }

    async function handleOffer(offer) {
      peer = new RTCPeerConnection();

      peer.ontrack = e => {
        document.getElementById("remoteVideo").srcObject = e.streams[0];
      };

      localStream.getTracks().forEach(track => peer.addTrack(track, localStream));

      peer.onicecandidate = e => {
        if (e.candidate) {
          connection.send(JSON.stringify({ type: "candidate", candidate: e.candidate }));
        }
      };

      await peer.setRemoteDescription(new RTCSessionDescription(offer));
      const answer = await peer.createAnswer();
      await peer.setLocalDescription(answer);

      connection.send(JSON.stringify({ type: "answer", answer }));
    }

    async function handleAnswer(answer) {
      await peer.setRemoteDescription(new RTCSessionDescription(answer));
    }

    start();
  </script>

</body>
</html>
